<!-- PANTALLA DE LOGIN/REGISTRO -->
@if (showWelcome()) {
  <div class="welcome-overlay">
    <div class="welcome-card">
      <img src="/assets/logoMistery.png" alt="Mystery Hunter Logo" class="mystery-logo">
  
      <h1 class="mystery-title">
        Mystery <span class="gold">Hunter</span>
      </h1>

      <h3 style="color: #d4af37; margin: 20px 0 15px 0;">
        @if (isLoginMode()) {
          Iniciar SesiÃ³n
        } @else {
          Crear Cuenta
        }
      </h3>
      
      <input 
        type="text" 
        #playerNameInput
        placeholder="Nombre de usuario..." 
        class="auth-input"
        style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #d4af37; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
      
      @if (nameError()) {
        <div class="error-message">{{ nameError() }}</div>
      }

      <input 
        type="password" 
        #passwordInput
        placeholder="ContraseÃ±a..." 
        class="auth-input"
        (keyup.enter)="handleAuth(playerNameInput.value, passwordInput.value)"
        style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #d4af37; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
      
      @if (passwordError()) {
        <div class="error-message">{{ passwordError() }}</div>
      }
      
      <button class="start-button" (click)="handleAuth(playerNameInput.value, passwordInput.value)">
        {{ isLoginMode() ? 'Entrar' : 'Registrarse' }}
      </button>

      <button class="toggle-mode-btn" (click)="toggleMode()">
        @if (isLoginMode()) {
          Â¿No tienes cuenta? <strong>RegÃ­strate</strong>
        } @else {
          Â¿Ya tienes cuenta? <strong>Inicia sesiÃ³n</strong>
        }
      </button>
    </div>
  </div>
}

<!-- PANTALLA DE INSTRUCCIONES (despuÃ©s del login) -->
@if (showInstructions()) {
  <div class="welcome-overlay">
    <div class="welcome-card">
      <img src="/assets/logoMistery.png" alt="Mystery Hunter Logo" class="mystery-logo">
  
      <h1 class="mystery-title">
        Mystery <span class="gold">Hunter</span>
      </h1>

      <div class="description-box">
        <p>Bienvenido al desafÃ­o definitivo. Explora tu entorno, resuelve enigmas histÃ³ricos y compite por ser el mejor investigador.</p>
        
        <ul>
          <li>Encuentra puntos de interÃ©s en el mapa.</li>
          <li>AcÃ©rcate fÃ­sicamente para desbloquear el misterio.</li>
          <li>Resuelve el acertijo y gana puntos para el ranking.</li>
        </ul>
      </div>
      
      <button class="start-button" (click)="closeInstructions()">
        Â¡Comenzar!
      </button>
    </div>
  </div>
}

<div id="map" style="height: 100vh; width: 100%"></div>

@if (!showWelcome() && !showInstructions()) {
  <button class="locate-button" (click)="goToCurrentLocation()">
    ğŸ¯
  </button>
}

<div class="score-container">ğŸ† Puntos: {{ totalPoints() }}</div>

@if (!showWelcome() && !showInstructions()) {
  <button class="logout-button" (click)="logout()">
    ğŸšª Salir
  </button>
}

<div class="ranking-container" [class.expanded]="showRanking()">
  <button class="ranking-toggle" (click)="toggleRanking()">
    <span class="icon">ğŸ†</span>
    <span class="text">Ranking</span>
  </button>

  @if (showRanking()) {
    <div class="ranking-content">
      <h3 class="ranking-title">ğŸ† Top Jugadores</h3>

      @if (loadingRanking()) {
        <div class="loading">Cargando...</div>
      } @else if (topPlayers().length === 0) {
        <div class="no-players">No hay jugadores aÃºn</div>
      } @else {
        <div class="players-list">
          @for (player of getVisiblePlayers(); track player.id; let idx = $index) {
            <div class="player-item" [class.current-user]="player.id === userId">
              <div class="rank">
                @if (idx === 0) {
                  <span class="medal gold">ğŸ¥‡</span>
                } @else if (idx === 1) {
                  <span class="medal silver">ğŸ¥ˆ</span>
                } @else if (idx === 2) {
                  <span class="medal bronze">ğŸ¥‰</span>
                } @else {
                  <span class="position">#{{ idx + 1 }}</span>
                }
              </div>

              <div class="player-info">
                <span class="player-name">
                  {{ player.nombre }}
                  @if (player.id === userId) {
                    <span class="you-badge">(TÃº)</span>
                  }
                </span>
                <span class="mysteries-count">
                  {{ player.misteriosResueltos || 0 }} misterios
                </span>
              </div>

              <div class="player-points">
                {{ player.puntos }}
                <span class="pts">pts</span>
              </div>
            </div>
          }
        </div>

        @if (topPlayers().length > 6) {
          <button class="show-more-btn" (click)="toggleShowAllPlayers()">
            @if (showAllPlayers()) {
              <span>â–² Mostrar menos</span>
            } @else {
              <span>â–¼ Ver mÃ¡s jugadores</span>
            }
          </button>
        }
      }

      @if (userRank() && userRank()! > 10) {
        <div class="user-position">
          <div class="separator">...</div>
          <div class="player-item current-user">
            <div class="rank">
              <span class="position">#{{ userRank() }}</span>
            </div>
            <div class="player-info">
              <span class="player-name">
                {{ userId }}
                <span class="you-badge">(TÃº)</span>
              </span>
            </div>
            <div class="player-points">
              {{ totalPoints() }}
              <span class="pts">pts</span>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>

@if (showSuccessModal()) {
  <div class="success-modal-overlay">
    <div class="success-modal" (click)="$event.stopPropagation()">
      <div class="success-emoji">ğŸ‰</div>
      <h2 class="success-title">Â¡Felicidades!</h2>
      <p class="success-subtitle">Has resuelto el misterio de</p>
      <p class="success-mystery-title">{{ solvedMysteryTitle() }}</p>
      <div class="success-points">+{{ earnedPoints() }} puntos</div>
      <button class="success-close-btn" (click)="closeSuccessModal()">Continuar</button>
    </div>
  </div>
}

@if (selectedMystery()) {
  <div class="mystery-card-overlay">
    <div class="mystery-card">
      <button class="close-btn" (click)="selectedMystery.set(null)">Ã—</button>

      <div class="card-header">
        <h2>{{ selectedMystery().titulo }}</h2>
      </div>

      <div class="card-body">
        <p class="description">{{ selectedMystery().descripcion }}</p>

        <div class="riddle-section">
          <span class="riddle-label">ğŸ” El Acertijo:</span>
          <p class="riddle-text">{{ selectedMystery().acertijo }}</p>
        </div>

        <div class="answer-section">
          <input
            type="text"
            placeholder="Escribe la respuesta..."
            #userAnswer
            (keyup.enter)="checkAnswer(userAnswer.value)"
          />
          <button (click)="checkAnswer(userAnswer.value)">Comprobar</button>
        </div>
      </div>
    </div>
  </div>
}

<router-outlet></router-outlet>